<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Gas and Fees | Ethermint Documentation</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="Learn about the differences between Gas and Fees in Ethereum and Cosmos.">
    
    <link rel="preload" href="/main/assets/css/0.styles.35583e2b.css" as="style"><link rel="preload" href="/main/assets/js/app.f98083fb.js" as="script"><link rel="preload" href="/main/assets/js/24.fa347e59.js" as="script"><link rel="preload" href="/main/assets/js/21.d7c2ac56.js" as="script"><link rel="preload" href="/main/assets/js/19.0625d28d.js" as="script"><link rel="preload" href="/main/assets/js/25.9b8f94a0.js" as="script"><link rel="preload" href="/main/assets/js/52.8a695dc5.js" as="script"><link rel="preload" href="/main/assets/js/36.76bee6e4.js" as="script"><link rel="preload" href="/main/assets/js/10.f3e7ad84.js" as="script"><link rel="preload" href="/main/assets/js/7.b6a5918a.js" as="script"><link rel="preload" href="/main/assets/js/71.ac84ee59.js" as="script"><link rel="preload" href="/main/assets/js/2.885a972b.js" as="script"><link rel="preload" href="/main/assets/js/5.6324f117.js" as="script"><link rel="preload" href="/main/assets/js/34.f012bdf6.js" as="script"><link rel="preload" href="/main/assets/js/13.9564c10f.js" as="script"><link rel="preload" href="/main/assets/js/12.8ae7e994.js" as="script"><link rel="preload" href="/main/assets/js/20.e5b1c9ce.js" as="script"><link rel="prefetch" href="/main/assets/js/100.840815c8.js"><link rel="prefetch" href="/main/assets/js/101.420f579b.js"><link rel="prefetch" href="/main/assets/js/102.d29803b1.js"><link rel="prefetch" href="/main/assets/js/103.3b112e5e.js"><link rel="prefetch" href="/main/assets/js/104.e9885ebd.js"><link rel="prefetch" href="/main/assets/js/11.ec652d7c.js"><link rel="prefetch" href="/main/assets/js/14.718261ae.js"><link rel="prefetch" href="/main/assets/js/15.9694447a.js"><link rel="prefetch" href="/main/assets/js/16.cfcde086.js"><link rel="prefetch" href="/main/assets/js/17.e7d32137.js"><link rel="prefetch" href="/main/assets/js/18.bc53b044.js"><link rel="prefetch" href="/main/assets/js/22.a2b1ebc1.js"><link rel="prefetch" href="/main/assets/js/23.a1f43df1.js"><link rel="prefetch" href="/main/assets/js/26.ab9548ed.js"><link rel="prefetch" href="/main/assets/js/27.f88b6f3b.js"><link rel="prefetch" href="/main/assets/js/28.9a14b9f4.js"><link rel="prefetch" href="/main/assets/js/29.13d743d9.js"><link rel="prefetch" href="/main/assets/js/3.34202bc1.js"><link rel="prefetch" href="/main/assets/js/30.67692bcc.js"><link rel="prefetch" href="/main/assets/js/31.ad4b5db9.js"><link rel="prefetch" href="/main/assets/js/32.2abe0940.js"><link rel="prefetch" href="/main/assets/js/33.b31c954f.js"><link rel="prefetch" href="/main/assets/js/35.9e5a739e.js"><link rel="prefetch" href="/main/assets/js/37.71844678.js"><link rel="prefetch" href="/main/assets/js/38.e01801e8.js"><link rel="prefetch" href="/main/assets/js/39.c836b761.js"><link rel="prefetch" href="/main/assets/js/4.2b9ad15a.js"><link rel="prefetch" href="/main/assets/js/40.48828fea.js"><link rel="prefetch" href="/main/assets/js/41.7907bfe5.js"><link rel="prefetch" href="/main/assets/js/42.989c5394.js"><link rel="prefetch" href="/main/assets/js/43.0c2de660.js"><link rel="prefetch" href="/main/assets/js/44.b44f090f.js"><link rel="prefetch" href="/main/assets/js/45.102eb30c.js"><link rel="prefetch" href="/main/assets/js/46.9f11a35f.js"><link rel="prefetch" href="/main/assets/js/47.46c4be86.js"><link rel="prefetch" href="/main/assets/js/48.eecbd7ca.js"><link rel="prefetch" href="/main/assets/js/49.c5e247a7.js"><link rel="prefetch" href="/main/assets/js/50.1cf8eb5b.js"><link rel="prefetch" href="/main/assets/js/51.123f5837.js"><link rel="prefetch" href="/main/assets/js/53.d7bc16f4.js"><link rel="prefetch" href="/main/assets/js/54.081fccd7.js"><link rel="prefetch" href="/main/assets/js/55.1f9563ee.js"><link rel="prefetch" href="/main/assets/js/56.a0029a88.js"><link rel="prefetch" href="/main/assets/js/57.a3bd9dce.js"><link rel="prefetch" href="/main/assets/js/58.6fe850a7.js"><link rel="prefetch" href="/main/assets/js/59.d6f1646c.js"><link rel="prefetch" href="/main/assets/js/6.e970546c.js"><link rel="prefetch" href="/main/assets/js/60.7ff8c410.js"><link rel="prefetch" href="/main/assets/js/61.041c2aca.js"><link rel="prefetch" href="/main/assets/js/62.93905176.js"><link rel="prefetch" href="/main/assets/js/63.10123aec.js"><link rel="prefetch" href="/main/assets/js/64.4dedc1de.js"><link rel="prefetch" href="/main/assets/js/65.59ac9d9d.js"><link rel="prefetch" href="/main/assets/js/66.d53e6ac5.js"><link rel="prefetch" href="/main/assets/js/67.41816bca.js"><link rel="prefetch" href="/main/assets/js/68.f9959e1a.js"><link rel="prefetch" href="/main/assets/js/69.8b34bb5d.js"><link rel="prefetch" href="/main/assets/js/70.27d5a345.js"><link rel="prefetch" href="/main/assets/js/72.1626929e.js"><link rel="prefetch" href="/main/assets/js/73.e0f52c3e.js"><link rel="prefetch" href="/main/assets/js/74.2fb4a4cb.js"><link rel="prefetch" href="/main/assets/js/75.50e67248.js"><link rel="prefetch" href="/main/assets/js/76.ad4f4a00.js"><link rel="prefetch" href="/main/assets/js/77.7f95c190.js"><link rel="prefetch" href="/main/assets/js/78.7b68c788.js"><link rel="prefetch" href="/main/assets/js/79.569b574f.js"><link rel="prefetch" href="/main/assets/js/8.a214909e.js"><link rel="prefetch" href="/main/assets/js/80.1d1e82a9.js"><link rel="prefetch" href="/main/assets/js/81.332887c2.js"><link rel="prefetch" href="/main/assets/js/82.91f1b67b.js"><link rel="prefetch" href="/main/assets/js/83.a07b5049.js"><link rel="prefetch" href="/main/assets/js/84.4b53310c.js"><link rel="prefetch" href="/main/assets/js/85.f0eb8f76.js"><link rel="prefetch" href="/main/assets/js/86.1ef85f57.js"><link rel="prefetch" href="/main/assets/js/87.200e06e9.js"><link rel="prefetch" href="/main/assets/js/88.d049fcb5.js"><link rel="prefetch" href="/main/assets/js/89.cd93ebde.js"><link rel="prefetch" href="/main/assets/js/9.5630644e.js"><link rel="prefetch" href="/main/assets/js/90.8d65d87d.js"><link rel="prefetch" href="/main/assets/js/91.5655cbfb.js"><link rel="prefetch" href="/main/assets/js/92.d9db30d7.js"><link rel="prefetch" href="/main/assets/js/93.b527f3eb.js"><link rel="prefetch" href="/main/assets/js/94.6fc22d6d.js"><link rel="prefetch" href="/main/assets/js/95.1ee35b9f.js"><link rel="prefetch" href="/main/assets/js/96.5cefcbea.js"><link rel="prefetch" href="/main/assets/js/97.20388cda.js"><link rel="prefetch" href="/main/assets/js/98.e4caaacb.js"><link rel="prefetch" href="/main/assets/js/99.ecb0e5f4.js">
    <link rel="stylesheet" href="/main/assets/css/0.styles.35583e2b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div data-v-58560e81><div data-v-40401285 data-v-58560e81><div class="banner-wrapper" data-v-40401285 data-v-40401285><div class="wrapper" data-v-40401285><div class="message" data-v-40401285>By using this website, you agree to our <a href="https://www.cookiesandyou.com" target="_blank" rel="noopener" style="color:#505FFF;" data-v-40401285>Cookie Policy</a>.</div> <div class="box" data-v-40401285><span class="icon-cross" data-v-40401285><svg width="16" height="16" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-40401285><path d="M1.66669 1.66669L12.3334 12.3334M12.3334 1.66669L1.66664 12.3334" stroke="#A2A3AD" stroke-width="1.5" stroke-linecap="round" data-v-40401285></path></svg></span></div></div></div></div><!----><div class="layout" data-v-58560e81><div class="layout__sidebar" data-v-58560e81><div style="height:100%;position:relative;" data-v-ab16c0b6 data-v-58560e81><div class="container" data-v-ab16c0b6><a href="/main/" class="logo__container router-link-active" data-v-ab16c0b6><div class="logo" data-v-ab16c0b6><div class="logo__img__custom" data-v-ab16c0b6><img src="/logo.svg" data-v-ab16c0b6></div><!----></div></a><div class="items footer__compact__false" data-v-ab16c0b6><div class="sidebar" style="display:none;" data-v-ab16c0b6><div class="title" data-v-ab16c0b6></div><!----></div><div class="sidebar" style="display:block;" data-v-ab16c0b6><div class="title" data-v-ab16c0b6>Reference</div><!----></div><div class="sidebar" style="display:block;" data-v-ab16c0b6><div class="title" data-v-ab16c0b6>Specifications</div><!----></div><div class="sidebar" style="display:block;" data-v-ab16c0b6><div class="title" data-v-ab16c0b6>Resources</div><!----></div><div class="sidebar version" data-v-ab16c0b6><div data-v-08503e1b data-v-ab16c0b6><div class="container" data-v-08503e1b><span class="sr-only" data-v-08503e1b>Docs Version Switcher</span><div class="select" data-v-08503e1b><select data-v-08503e1b><option value="" disabled="disabled" data-v-08503e1b>Version</option><option value="main" data-v-08503e1b>main</option></select></div></div></div></div></div><!----></div></div></div><div class="layout__main" data-v-58560e81><div class="layout__main__navbar" data-v-58560e81><div data-v-19189c02 data-v-58560e81><div class="container" data-v-19189c02><div class="menu" data-v-19189c02><div class="menu__icon" data-v-19189c02><svg width="100%" height="100%" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="#888" data-v-19189c02><path d="M2 5H22M2 12H22M2 19H22" stroke-width="1.5" stroke-linecap="round"></path></svg></div></div><div class="logo" data-v-19189c02><div class="logo__wrapper router-link-active" data-v-19189c02><div class="logo__image__custom" data-v-19189c02><img src="/logo.svg" class="logo__image__custom__img" data-v-19189c02></div><!----></div></div><div class="toolbar" data-v-19189c02><div class="toolbar__item" data-v-19189c02><div class="toolbar__item__icon" data-v-19189c02><svg width="100%" height="100%" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="#888" data-v-19189c02><path fill-rule="evenodd" clip-rule="evenodd" d="M11.5 2.75C6.66751 2.75 2.75 6.66751 2.75 11.5C2.75 16.3325 6.66751 20.25 11.5 20.25C13.6462 20.25 15.612 19.4773 17.1342 18.1949L22.6697 23.7303C22.9626 24.0232 23.4374 24.0232 23.7303 23.7303C24.0232 23.4374 24.0232 22.9626 23.7303 22.6697L18.1949 17.1342C19.4773 15.612 20.25 13.6462 20.25 11.5C20.25 6.66751 16.3325 2.75 11.5 2.75ZM16.6923 16.5599C17.9656 15.2535 18.75 13.4684 18.75 11.5C18.75 7.49594 15.5041 4.25 11.5 4.25C7.49594 4.25 4.25 7.49594 4.25 11.5C4.25 15.5041 7.49594 18.75 11.5 18.75C13.4684 18.75 15.2535 17.9656 16.5599 16.6923C16.5789 16.6679 16.5996 16.6444 16.622 16.622C16.6444 16.5996 16.6679 16.5789 16.6923 16.5599Z"></path></svg></div></div></div></div></div></div><div class="layout__main__content aside__true" data-v-58560e81><div id="content-scroll" class="layout__main__content__body" data-v-58560e81><div class="layout__main__content__body__breadcrumbs" data-v-58560e81><div data-v-48fb2d7a data-v-58560e81><div class="container" data-v-48fb2d7a><div class="crumbs" data-v-48fb2d7a><a href="/main/" class="crumbs__item router-link-active" data-v-48fb2d7a>Ethermint Documentation</a><a href="/main/basics/" class="crumbs__item router-link-active" data-v-48fb2d7a>Basics</a><a href="/main/basics/gas.html" aria-current="page" class="crumbs__item router-link-exact-active router-link-active" data-v-48fb2d7a>Gas and Fees</a></div><div class="menu" data-v-48fb2d7a><div class="menu__item" style="visibility:visible;" data-v-48fb2d7a><svg width="100%" height="100%" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="menu__item__icon menu__item__icon__active__false" data-v-48fb2d7a><path fill-rule="evenodd" clip-rule="evenodd" d="M0.25 2C0.25 1.58579 0.585786 1.25 1 1.25H6C6.41421 1.25 6.75 1.58579 6.75 2C6.75 2.41421 6.41421 2.75 6 2.75H1C0.585786 2.75 0.25 2.41421 0.25 2ZM17.53 22.7803L16.9997 22.25L17.53 22.7803L17.5301 22.7802L17.5305 22.7798L17.5322 22.7781L17.5388 22.7715L17.5647 22.7456L17.6647 22.6456L18.0367 22.2737L19.2978 21.0126L22.53 17.7803C22.8229 17.4874 22.8229 17.0126 22.53 16.7197C22.2371 16.4268 21.7622 16.4268 21.4693 16.7197L18.2371 19.9519L17.7497 20.4393V8.5C17.7497 6.34186 17.0721 4.51182 15.7802 3.21983C14.4882 1.92783 12.6581 1.25031 10.5 1.25031C10.0858 1.25031 9.75 1.5861 9.75 2.00031C9.75 2.41453 10.0858 2.75031 10.5 2.75031C12.3419 2.75031 13.7617 3.32264 14.7195 4.28049C15.6773 5.23834 16.2497 6.65814 16.2497 8.5L16.2497 20.4393L12.53 16.7197C12.2371 16.4268 11.7622 16.4268 11.4693 16.7197C11.1764 17.0126 11.1764 17.4874 11.4693 17.7803L16.4693 22.7803L16.9997 23.3107L17.53 22.7803ZM1 6.25C0.585786 6.25 0.25 6.58579 0.25 7C0.25 7.41421 0.585786 7.75 1 7.75H10C10.4142 7.75 10.75 7.41421 10.75 7C10.75 6.58579 10.4142 6.25 10 6.25H1ZM0.25 12C0.25 11.5858 0.585786 11.25 1 11.25H12C12.4142 11.25 12.75 11.5858 12.75 12C12.75 12.4142 12.4142 12.75 12 12.75H1C0.585786 12.75 0.25 12.4142 0.25 12ZM1 16.25C0.585786 16.25 0.25 16.5858 0.25 17C0.25 17.4142 0.585786 17.75 1 17.75H8C8.41421 17.75 8.75 17.4142 8.75 17C8.75 16.5858 8.41421 16.25 8 16.25H1Z" data-v-48fb2d7a></path></svg><!----></div></div></div></div></div><div class="layout__main__content__body__wrapper" data-v-58560e81><div style="width:100%;" data-v-c85ed208 data-v-58560e81><div class="search__container" data-v-c85ed208><div class="search" data-v-c85ed208><div class="search__icon" data-v-c85ed208><svg width="100%" height="100%" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" data-v-c85ed208><path fill-rule="evenodd" clip-rule="evenodd" d="M11.5 2.75C6.66751 2.75 2.75 6.66751 2.75 11.5C2.75 16.3325 6.66751 20.25 11.5 20.25C13.6462 20.25 15.612 19.4773 17.1342 18.1949L22.6697 23.7303C22.9626 24.0232 23.4374 24.0232 23.7303 23.7303C24.0232 23.4374 24.0232 22.9626 23.7303 22.6697L18.1949 17.1342C19.4773 15.612 20.25 13.6462 20.25 11.5C20.25 6.66751 16.3325 2.75 11.5 2.75ZM16.6923 16.5599C17.9656 15.2535 18.75 13.4684 18.75 11.5C18.75 7.49594 15.5041 4.25 11.5 4.25C7.49594 4.25 4.25 7.49594 4.25 11.5C4.25 15.5041 7.49594 18.75 11.5 18.75C13.4684 18.75 15.2535 17.9656 16.5599 16.6923C16.5789 16.6679 16.5996 16.6444 16.622 16.622C16.6444 16.5996 16.6679 16.5789 16.6923 16.5599Z"></path></svg></div><div class="search__text" data-v-c85ed208>Search</div></div></div><div class="container" data-v-c85ed208><div class="content__default" data-v-58560e81><h1 id="gas-and-fees"><a href="#gas-and-fees" class="header-anchor">#</a> Gas and Fees</h1> <p synopsis="">Learn about the differences between <code>Gas</code> and <code>Fees</code> in Ethereum and Cosmos.</p> <h2 id="pre-requisite-readings"><a href="#pre-requisite-readings" class="header-anchor">#</a> Pre-requisite Readings</h2> <ul><li prereq=""><a href="https://docs.cosmos.network/master/basics/gas-fees.html" target="_blank" rel="noopener noreferrer">Cosmos SDK Gas<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li prereq=""><a href="https://ethereum.org/en/developers/docs/gas/" target="_blank" rel="noopener noreferrer">Ethereum Gas<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p>The concept of Gas represents the amount of computational effort required to execute specific operations on the state machine.</p> <p>Gas was created on Ethereum to disallow the EVM (Ethereum Virtual Machine) from running infinite
loops by allocating a small amount of monetary value into the system. A unit of gas, usually in a
form as a fraction of the native coin, is consumed for every operation on the EVM and requires a
user to pay for these operations. These operations consist in state transitions such as sending a
transaction or calling a contract.</p> <p>Exactly like Ethereum, Cosmos utilizes the concept of gas and this is how Cosmos tracks the resource
usage of operations during execution. Operations on Cosmos are represented as read or writes done to the chain's store.</p> <p>In Cosmos, a fee is calculated and charged to the user during a message execution. This fee is
calculated from the sum of all gas consumed in an message execution:</p> <span class="codeblock" data-v-1eda75b2><span class="container codeblock__hasfooter__false codeblock__is-expandable__false codeblock__expanded__false" data-v-1eda75b2><span class="body__container" data-v-1eda75b2><span class="body__block" data-v-1eda75b2><span class="icons" data-v-1eda75b2><!----> <span class="icons__item" data-v-1eda75b2><svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="icons__item__icon" data-v-1eda75b2><path fill-rule="evenodd" clip-rule="evenodd" d="M11 0.25C10.0335 0.25 9.25 1.0335 9.25 2V4.5H10.75V2C10.75 1.86193 10.8619 1.75 11 1.75H21C21.1381 1.75 21.25 1.86193 21.25 2V16C21.25 16.1381 21.1381 16.25 21 16.25H16.5V17.75H21C21.9665 17.75 22.75 16.9665 22.75 16V2C22.75 1.0335 21.9665 0.25 21 0.25H11ZM3 6.25C2.0335 6.25 1.25 7.0335 1.25 8V22C1.25 22.9665 2.0335 23.75 3 23.75H13C13.9665 23.75 14.75 22.9665 14.75 22V8C14.75 7.0335 13.9665 6.25 13 6.25H3ZM2.75 8C2.75 7.86193 2.86193 7.75 3 7.75H13C13.1381 7.75 13.25 7.86193 13.25 8V22C13.25 22.1381 13.1381 22.25 13 22.25H3C2.86193 22.25 2.75 22.1381 2.75 22V8Z" data-v-1eda75b2></path></svg> <span class="icons__item__tooltip" data-v-1eda75b2>
              Copy
            </span></span></span> <span class="body" data-v-1eda75b2><span class="body__wrapper" data-v-1eda75b2><span class="body__code" data-v-1eda75b2>fee = gas * gas price
</span></span></span></span> <!----></span> <!----></span></span> <p>In both networks, gas is used to make sure that operations do not require an excess amount of
computational power to complete and as a way to deter bad-acting users from spamming the network.</p> <h2 id="cosmos-sdk-gas"><a href="#cosmos-sdk-gas" class="header-anchor">#</a> Cosmos SDK <code>Gas</code></h2> <p>In the Cosmos SDK, gas is tracked in the main <code>GasMeter</code> and the <code>BlockGasMeter</code>:</p> <ul><li><code>GasMeter</code>: keeps track of the gas consumed during executions that lead to state transitions. It is reset on every transaction execution.</li> <li><code>BlockGasMeter</code>: keeps track of the gas consumed in a block and enforces that the gas does not go over a predefined limit. This limit is defined in the Tendermint consensus parameters and can be changed via governance parameter change proposals.</li></ul> <p>More information regarding gas in Cosmos SDK can be found <a href="https://docs.cosmos.network/master/basics/gas-fees.html" target="_blank" rel="noopener noreferrer">here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h2 id="matching-evm-gas-consumption"><a href="#matching-evm-gas-consumption" class="header-anchor">#</a> Matching EVM Gas consumption</h2> <p>Ethermint is an EVM-compatible chain that supports Ethereum Web3 tooling. For this reason, gas
consumption must be equitable with other EVMs, most importantly Ethereum.</p> <p>The main difference between EVM and Cosmos state transitions, is that the EVM uses a <a href="https://github.com/ethereum/go-ethereum/blob/master/params/protocol_params.go" target="_blank" rel="noopener noreferrer">gas table<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> for each OPCODE, whereas Cosmos uses a <code>GasConfig</code> that charges gas for each CRUD operation by setting a flat and per-byte cost for accessing the database.</p> <p><span class="codeblock" data-v-1eda75b2><span class="container codeblock__hasfooter__false codeblock__is-expandable__false codeblock__expanded__false" data-v-1eda75b2><span class="body__container" data-v-1eda75b2><span class="body__block" data-v-1eda75b2><span class="icons" data-v-1eda75b2><!----> <span class="icons__item" data-v-1eda75b2><svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="icons__item__icon" data-v-1eda75b2><path fill-rule="evenodd" clip-rule="evenodd" d="M11 0.25C10.0335 0.25 9.25 1.0335 9.25 2V4.5H10.75V2C10.75 1.86193 10.8619 1.75 11 1.75H21C21.1381 1.75 21.25 1.86193 21.25 2V16C21.25 16.1381 21.1381 16.25 21 16.25H16.5V17.75H21C21.9665 17.75 22.75 16.9665 22.75 16V2C22.75 1.0335 21.9665 0.25 21 0.25H11ZM3 6.25C2.0335 6.25 1.25 7.0335 1.25 8V22C1.25 22.9665 2.0335 23.75 3 23.75H13C13.9665 23.75 14.75 22.9665 14.75 22V8C14.75 7.0335 13.9665 6.25 13 6.25H3ZM2.75 8C2.75 7.86193 2.86193 7.75 3 7.75H13C13.1381 7.75 13.25 7.86193 13.25 8V22C13.25 22.1381 13.1381 22.25 13 22.25H3C2.86193 22.25 2.75 22.1381 2.75 22V8Z" data-v-1eda75b2></path></svg> <span class="icons__item__tooltip" data-v-1eda75b2>
              Copy
            </span></span></span> <span class="body" data-v-1eda75b2><span class="body__wrapper" data-v-1eda75b2><span class="body__code" data-v-1eda75b2><span class="token comment">// GasConfig defines gas cost for each operation on KVStores</span>
<span class="token keyword">type</span> GasConfig <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	HasCost          Gas
	DeleteCost       Gas
	ReadCostFlat     Gas
	ReadCostPerByte  Gas
	WriteCostFlat    Gas
	WriteCostPerByte Gas
	IterNextCostFlat Gas
<span class="token punctuation">}</span></span></span></span></span> <!----></span> <!----></span></span></p> <p>In order to match the the gas consumed by the EVM, the gas consumption logic from the SDK is ignored, and instead the gas consumed is calculated by subtracting the state transition leftover gas plus refund from the gas limit defined on the message.</p> <p>To ignore the SDK gas consumption, we reset the transaction <code>GasMeter</code> count to 0 and manually set it to the <code>gasUsed</code> value computed by the EVM module at the end of the execution.</p> <p><span class="codeblock" data-v-1eda75b2><span class="container codeblock__hasfooter__false codeblock__is-expandable__false codeblock__expanded__false" data-v-1eda75b2><span class="body__container" data-v-1eda75b2><span class="body__block" data-v-1eda75b2><span class="icons" data-v-1eda75b2><!----> <span class="icons__item" data-v-1eda75b2><svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="icons__item__icon" data-v-1eda75b2><path fill-rule="evenodd" clip-rule="evenodd" d="M11 0.25C10.0335 0.25 9.25 1.0335 9.25 2V4.5H10.75V2C10.75 1.86193 10.8619 1.75 11 1.75H21C21.1381 1.75 21.25 1.86193 21.25 2V16C21.25 16.1381 21.1381 16.25 21 16.25H16.5V17.75H21C21.9665 17.75 22.75 16.9665 22.75 16V2C22.75 1.0335 21.9665 0.25 21 0.25H11ZM3 6.25C2.0335 6.25 1.25 7.0335 1.25 8V22C1.25 22.9665 2.0335 23.75 3 23.75H13C13.9665 23.75 14.75 22.9665 14.75 22V8C14.75 7.0335 13.9665 6.25 13 6.25H3ZM2.75 8C2.75 7.86193 2.86193 7.75 3 7.75H13C13.1381 7.75 13.25 7.86193 13.25 8V22C13.25 22.1381 13.1381 22.25 13 22.25H3C2.86193 22.25 2.75 22.1381 2.75 22V8Z" data-v-1eda75b2></path></svg> <span class="icons__item__tooltip" data-v-1eda75b2>
              Copy
            </span></span></span> <span class="body" data-v-1eda75b2><span class="body__wrapper" data-v-1eda75b2><span class="body__code" data-v-1eda75b2><span class="token keyword">package</span> keeper

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"math/big"</span>
	<span class="token string">"os"</span>
	<span class="token string">"time"</span>

	<span class="token string">"github.com/palantir/stacktrace"</span>
	tmtypes <span class="token string">"github.com/tendermint/tendermint/types"</span>

	<span class="token string">"github.com/cosmos/cosmos-sdk/telemetry"</span>
	sdk <span class="token string">"github.com/cosmos/cosmos-sdk/types"</span>
	sdkerrors <span class="token string">"github.com/cosmos/cosmos-sdk/types/errors"</span>
	authtypes <span class="token string">"github.com/cosmos/cosmos-sdk/x/auth/types"</span>
	stakingtypes <span class="token string">"github.com/cosmos/cosmos-sdk/x/staking/types"</span>

	ethermint <span class="token string">"github.com/tharsis/ethermint/types"</span>
	<span class="token string">"github.com/tharsis/ethermint/x/evm/types"</span>

	<span class="token string">"github.com/ethereum/go-ethereum/common"</span>
	<span class="token string">"github.com/ethereum/go-ethereum/core"</span>
	ethtypes <span class="token string">"github.com/ethereum/go-ethereum/core/types"</span>
	<span class="token string">"github.com/ethereum/go-ethereum/core/vm"</span>
	<span class="token string">"github.com/ethereum/go-ethereum/params"</span>
<span class="token punctuation">)</span>

<span class="token comment">// NewEVM generates a go-ethereum VM from the provided Message fields and the chain parameters</span>
<span class="token comment">// (ChainConfig and module Params). It additionally sets the validator operator address as the</span>
<span class="token comment">// coinbase address to make it available for the COINBASE opcode, even though there is no</span>
<span class="token comment">// beneficiary of the coinbase transaction (since we're not mining).</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>k <span class="token operator">*</span>Keeper<span class="token punctuation">)</span> <span class="token function">NewEVM</span><span class="token punctuation">(</span>msg core<span class="token punctuation">.</span>Message<span class="token punctuation">,</span> config <span class="token operator">*</span>params<span class="token punctuation">.</span>ChainConfig<span class="token punctuation">,</span> params types<span class="token punctuation">.</span>Params<span class="token punctuation">,</span> coinbase common<span class="token punctuation">.</span>Address<span class="token punctuation">)</span> <span class="token operator">*</span>vm<span class="token punctuation">.</span>EVM <span class="token punctuation">{</span>
	blockCtx <span class="token operator">:=</span> vm<span class="token punctuation">.</span>BlockContext<span class="token punctuation">{</span>
		CanTransfer<span class="token punctuation">:</span> core<span class="token punctuation">.</span>CanTransfer<span class="token punctuation">,</span>
		Transfer<span class="token punctuation">:</span>    core<span class="token punctuation">.</span>Transfer<span class="token punctuation">,</span>
		GetHash<span class="token punctuation">:</span>     k<span class="token punctuation">.</span><span class="token function">GetHashFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		Coinbase<span class="token punctuation">:</span>    coinbase<span class="token punctuation">,</span>
		GasLimit<span class="token punctuation">:</span>    ethermint<span class="token punctuation">.</span><span class="token function">BlockGasLimit</span><span class="token punctuation">(</span>k<span class="token punctuation">.</span>ctx<span class="token punctuation">)</span><span class="token punctuation">,</span>
		BlockNumber<span class="token punctuation">:</span> big<span class="token punctuation">.</span><span class="token function">NewInt</span><span class="token punctuation">(</span>k<span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">BlockHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		Time<span class="token punctuation">:</span>        big<span class="token punctuation">.</span><span class="token function">NewInt</span><span class="token punctuation">(</span>k<span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">BlockHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Time<span class="token punctuation">.</span><span class="token function">Unix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		Difficulty<span class="token punctuation">:</span>  big<span class="token punctuation">.</span><span class="token function">NewInt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// unused. Only required in PoW context</span>
	<span class="token punctuation">}</span>

	txCtx <span class="token operator">:=</span> core<span class="token punctuation">.</span><span class="token function">NewEVMTxContext</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
	vmConfig <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">VMConfig</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span>

	<span class="token keyword">return</span> vm<span class="token punctuation">.</span><span class="token function">NewEVM</span><span class="token punctuation">(</span>blockCtx<span class="token punctuation">,</span> txCtx<span class="token punctuation">,</span> k<span class="token punctuation">,</span> config<span class="token punctuation">,</span> vmConfig<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// VMConfig creates an EVM configuration from the debug setting and the extra EIPs enabled on the</span>
<span class="token comment">// module parameters. The config generated uses the default JumpTable from the EVM.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>k Keeper<span class="token punctuation">)</span> <span class="token function">VMConfig</span><span class="token punctuation">(</span>params types<span class="token punctuation">.</span>Params<span class="token punctuation">)</span> vm<span class="token punctuation">.</span>Config <span class="token punctuation">{</span>
	<span class="token keyword">return</span> vm<span class="token punctuation">.</span>Config<span class="token punctuation">{</span>
		Debug<span class="token punctuation">:</span>       k<span class="token punctuation">.</span>debug<span class="token punctuation">,</span>
		Tracer<span class="token punctuation">:</span>      vm<span class="token punctuation">.</span><span class="token function">NewJSONLogger</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>vm<span class="token punctuation">.</span>LogConfig<span class="token punctuation">{</span>Debug<span class="token punctuation">:</span> k<span class="token punctuation">.</span>debug<span class="token punctuation">}</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span>Stderr<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// TODO: consider using the Struct Logger too</span>
		NoRecursion<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>                                                      <span class="token comment">// TODO: consider disabling recursion though params</span>
		ExtraEips<span class="token punctuation">:</span>   params<span class="token punctuation">.</span><span class="token function">EIPs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// GetHashFn implements vm.GetHashFunc for Ethermint. It handles 3 cases:</span>
<span class="token comment">//  1. The requested height matches the current height from context (and thus same epoch number)</span>
<span class="token comment">//  2. The requested height is from an previous height from the same chain epoch</span>
<span class="token comment">//  3. The requested height is from a height greater than the latest one</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>k Keeper<span class="token punctuation">)</span> <span class="token function">GetHashFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> vm<span class="token punctuation">.</span>GetHashFunc <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>height <span class="token builtin">uint64</span><span class="token punctuation">)</span> common<span class="token punctuation">.</span>Hash <span class="token punctuation">{</span>
		h <span class="token operator">:=</span> <span class="token function">int64</span><span class="token punctuation">(</span>height<span class="token punctuation">)</span>
		<span class="token keyword">switch</span> <span class="token punctuation">{</span>
		<span class="token keyword">case</span> k<span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">BlockHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> h<span class="token punctuation">:</span>
			<span class="token comment">// Case 1: The requested height matches the one from the context so we can retrieve the header</span>
			<span class="token comment">// hash directly from the context.</span>
			<span class="token comment">// Note: The headerHash is only set at begin block, it will be nil in case of a query context</span>
			headerHash <span class="token operator">:=</span> k<span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">HeaderHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>headerHash<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> common<span class="token punctuation">.</span><span class="token function">BytesToHash</span><span class="token punctuation">(</span>headerHash<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>

			<span class="token comment">// only recompute the hash if not set (eg: checkTxState)</span>
			contextBlockHeader <span class="token operator">:=</span> k<span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">BlockHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			header<span class="token punctuation">,</span> err <span class="token operator">:=</span> tmtypes<span class="token punctuation">.</span><span class="token function">HeaderFromProto</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>contextBlockHeader<span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				k<span class="token punctuation">.</span><span class="token function">Logger</span><span class="token punctuation">(</span>k<span class="token punctuation">.</span>ctx<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"failed to cast tendermint header from proto"</span><span class="token punctuation">,</span> <span class="token string">"error"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
				<span class="token keyword">return</span> common<span class="token punctuation">.</span>Hash<span class="token punctuation">{</span><span class="token punctuation">}</span>
			<span class="token punctuation">}</span>

			headerHash <span class="token operator">=</span> header<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> common<span class="token punctuation">.</span><span class="token function">BytesToHash</span><span class="token punctuation">(</span>headerHash<span class="token punctuation">)</span>

		<span class="token keyword">case</span> k<span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">BlockHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> h<span class="token punctuation">:</span>
			<span class="token comment">// Case 2: if the chain is not the current height we need to retrieve the hash from the store for the</span>
			<span class="token comment">// current chain epoch. This only applies if the current height is greater than the requested height.</span>
			histInfo<span class="token punctuation">,</span> found <span class="token operator">:=</span> k<span class="token punctuation">.</span>stakingKeeper<span class="token punctuation">.</span><span class="token function">GetHistoricalInfo</span><span class="token punctuation">(</span>k<span class="token punctuation">.</span>ctx<span class="token punctuation">,</span> h<span class="token punctuation">)</span>
			<span class="token keyword">if</span> <span class="token operator">!</span>found <span class="token punctuation">{</span>
				k<span class="token punctuation">.</span><span class="token function">Logger</span><span class="token punctuation">(</span>k<span class="token punctuation">.</span>ctx<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"historical info not found"</span><span class="token punctuation">,</span> <span class="token string">"height"</span><span class="token punctuation">,</span> h<span class="token punctuation">)</span>
				<span class="token keyword">return</span> common<span class="token punctuation">.</span>Hash<span class="token punctuation">{</span><span class="token punctuation">}</span>
			<span class="token punctuation">}</span>

			header<span class="token punctuation">,</span> err <span class="token operator">:=</span> tmtypes<span class="token punctuation">.</span><span class="token function">HeaderFromProto</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>histInfo<span class="token punctuation">.</span>Header<span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				k<span class="token punctuation">.</span><span class="token function">Logger</span><span class="token punctuation">(</span>k<span class="token punctuation">.</span>ctx<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"failed to cast tendermint header from proto"</span><span class="token punctuation">,</span> <span class="token string">"error"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
				<span class="token keyword">return</span> common<span class="token punctuation">.</span>Hash<span class="token punctuation">{</span><span class="token punctuation">}</span>
			<span class="token punctuation">}</span>

			<span class="token keyword">return</span> common<span class="token punctuation">.</span><span class="token function">BytesToHash</span><span class="token punctuation">(</span>header<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">default</span><span class="token punctuation">:</span>
			<span class="token comment">// Case 3: heights greater than the current one returns an empty hash.</span>
			<span class="token keyword">return</span> common<span class="token punctuation">.</span>Hash<span class="token punctuation">{</span><span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// ApplyTransaction runs and attempts to perform a state transition with the given transaction (i.e Message), that will</span>
<span class="token comment">// only be persisted (committed) to the underlying KVStore if the transaction does not fail.</span>
<span class="token comment">//</span>
<span class="token comment">// Gas tracking</span>
<span class="token comment">//</span>
<span class="token comment">// Ethereum consumes gas according to the EVM opcodes instead of general reads and writes to store. Because of this, the</span>
<span class="token comment">// state transition needs to ignore the SDK gas consumption mechanism defined by the GasKVStore and instead consume the</span>
<span class="token comment">// amount of gas used by the VM execution. The amount of gas used is tracked by the EVM and returned in the execution</span>
<span class="token comment">// result.</span>
<span class="token comment">//</span>
<span class="token comment">// Prior to the execution, the starting tx gas meter is saved and replaced with an infinite gas meter in a new context</span>
<span class="token comment">// in order to ignore the SDK gas consumption config values (read, write, has, delete).</span>
<span class="token comment">// After the execution, the gas used from the message execution will be added to the starting gas consumed, taking into</span>
<span class="token comment">// consideration the amount of gas returned. Finally, the context is updated with the EVM gas consumed value prior to</span>
<span class="token comment">// returning.</span>
<span class="token comment">//</span>
<span class="token comment">// For relevant discussion see: https://github.com/cosmos/cosmos-sdk/discussions/9072</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>k <span class="token operator">*</span>Keeper<span class="token punctuation">)</span> <span class="token function">ApplyTransaction</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>ethtypes<span class="token punctuation">.</span>Transaction<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>types<span class="token punctuation">.</span>MsgEthereumTxResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> telemetry<span class="token punctuation">.</span><span class="token function">ModuleMeasureSince</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span>ModuleName<span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> types<span class="token punctuation">.</span>MetricKeyTransitionDB<span class="token punctuation">)</span>

	params <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">GetParams</span><span class="token punctuation">(</span>k<span class="token punctuation">.</span>ctx<span class="token punctuation">)</span>
	ethCfg <span class="token operator">:=</span> params<span class="token punctuation">.</span>ChainConfig<span class="token punctuation">.</span><span class="token function">EthereumConfig</span><span class="token punctuation">(</span>k<span class="token punctuation">.</span>eip155ChainID<span class="token punctuation">)</span>

	<span class="token comment">// get the latest signer according to the chain rules from the config</span>
	signer <span class="token operator">:=</span> ethtypes<span class="token punctuation">.</span><span class="token function">MakeSigner</span><span class="token punctuation">(</span>ethCfg<span class="token punctuation">,</span> big<span class="token punctuation">.</span><span class="token function">NewInt</span><span class="token punctuation">(</span>k<span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">BlockHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	msg<span class="token punctuation">,</span> err <span class="token operator">:=</span> tx<span class="token punctuation">.</span><span class="token function">AsMessage</span><span class="token punctuation">(</span>signer<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> stacktrace<span class="token punctuation">.</span><span class="token function">Propagate</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"failed to return ethereum transaction as core message"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// we use a cached context to avoid modifying to state in case EVM msg is reverted</span>
	commit <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">BeginCachedContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// get the coinbase address from the block proposer</span>
	coinbase<span class="token punctuation">,</span> err <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">GetCoinbaseAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> stacktrace<span class="token punctuation">.</span><span class="token function">Propagate</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"failed to obtain coinbase address"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// create an ethereum EVM instance and run the message</span>
	evm <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">NewEVM</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> ethCfg<span class="token punctuation">,</span> params<span class="token punctuation">,</span> coinbase<span class="token punctuation">)</span>

	txHash <span class="token operator">:=</span> tx<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// set the transaction hash and index to the impermanent (transient) block state so that it's also</span>
	<span class="token comment">// available on the StateDB functions (eg: AddLog)</span>
	k<span class="token punctuation">.</span><span class="token function">SetTxHashTransient</span><span class="token punctuation">(</span>txHash<span class="token punctuation">)</span>
	k<span class="token punctuation">.</span><span class="token function">IncreaseTxIndexTransient</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// pass false to execute in real mode, which do actual gas refunding</span>
	res<span class="token punctuation">,</span> err <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">ApplyMessage</span><span class="token punctuation">(</span>evm<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> ethCfg<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> stacktrace<span class="token punctuation">.</span><span class="token function">Propagate</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"failed to apply ethereum core message"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	res<span class="token punctuation">.</span>Hash <span class="token operator">=</span> txHash<span class="token punctuation">.</span><span class="token function">Hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	logs <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">GetTxLogs</span><span class="token punctuation">(</span>txHash<span class="token punctuation">)</span>

	<span class="token comment">// Commit and switch to committed context</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>res<span class="token punctuation">.</span><span class="token function">Failed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	k<span class="token punctuation">.</span><span class="token function">EndCachedContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// Logs needs to be ignored when tx is reverted</span>
	<span class="token comment">// Set the log and bloom filter only when the tx is NOT REVERTED</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>res<span class="token punctuation">.</span><span class="token function">Failed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		res<span class="token punctuation">.</span>Logs <span class="token operator">=</span> types<span class="token punctuation">.</span><span class="token function">NewLogsFromEth</span><span class="token punctuation">(</span>logs<span class="token punctuation">)</span>
		<span class="token comment">// Update block bloom filter in the original context because blockbloom is set in EndBlock</span>
		bloom <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">GetBlockBloomTransient</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		bloom<span class="token punctuation">.</span><span class="token function">Or</span><span class="token punctuation">(</span>bloom<span class="token punctuation">,</span> big<span class="token punctuation">.</span><span class="token function">NewInt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">SetBytes</span><span class="token punctuation">(</span>ethtypes<span class="token punctuation">.</span><span class="token function">LogsBloom</span><span class="token punctuation">(</span>logs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		k<span class="token punctuation">.</span><span class="token function">SetBlockBloomTransient</span><span class="token punctuation">(</span>bloom<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// update the gas used after refund</span>
	k<span class="token punctuation">.</span><span class="token function">resetGasMeterAndConsumeGas</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>GasUsed<span class="token punctuation">)</span>
	<span class="token keyword">return</span> res<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">// Gas consumption notes (write doc from this)</span>

<span class="token comment">// gas = remaining gas = limit - consumed</span>

<span class="token comment">// Gas consumption in ethereum:</span>
<span class="token comment">// 0. Buy gas -> deduct gasLimit * gasPrice from user account</span>
<span class="token comment">// 		0.1 leftover gas = gas limit</span>
<span class="token comment">// 1. consume intrinsic gas</span>
<span class="token comment">//   1.1 leftover gas = leftover gas - intrinsic gas</span>
<span class="token comment">// 2. Exec vm functions by passing the gas (i.e remaining gas)</span>
<span class="token comment">//   2.1 final leftover gas returned after spending gas from the opcodes jump tables</span>
<span class="token comment">// 3. Refund amount =  max(gasConsumed / 2, gas refund), where gas refund is a local variable</span>

<span class="token comment">// TODO: (@fedekunze) currently we consume the entire gas limit in the ante handler, so if a transaction fails</span>
<span class="token comment">// the amount spent will be grater than the gas spent in an Ethereum tx (i.e here the leftover gas won't be refunded).</span>

<span class="token comment">// ApplyMessage computes the new state by applying the given message against the existing state.</span>
<span class="token comment">// If the message fails, the VM execution error with the reason will be returned to the client</span>
<span class="token comment">// and the transaction won't be committed to the store.</span>
<span class="token comment">//</span>
<span class="token comment">// Reverted state</span>
<span class="token comment">//</span>
<span class="token comment">// The transaction is never "reverted" since there is no snapshot + rollback performed on the StateDB.</span>
<span class="token comment">// Only successful transactions are written to the store during DeliverTx mode.</span>
<span class="token comment">//</span>
<span class="token comment">// Prechecks and Preprocessing</span>
<span class="token comment">//</span>
<span class="token comment">// All relevant state transition prechecks for the MsgEthereumTx are performed on the AnteHandler,</span>
<span class="token comment">// prior to running the transaction against the state. The prechecks run are the following:</span>
<span class="token comment">//</span>
<span class="token comment">// 1. the nonce of the message caller is correct</span>
<span class="token comment">// 2. caller has enough balance to cover transaction fee(gaslimit * gasprice)</span>
<span class="token comment">// 3. the amount of gas required is available in the block</span>
<span class="token comment">// 4. the purchased gas is enough to cover intrinsic usage</span>
<span class="token comment">// 5. there is no overflow when calculating intrinsic gas</span>
<span class="token comment">// 6. caller has enough balance to cover asset transfer for **topmost** call</span>
<span class="token comment">//</span>
<span class="token comment">// The preprocessing steps performed by the AnteHandler are:</span>
<span class="token comment">//</span>
<span class="token comment">// 1. set up the initial access list (iff fork > Berlin)</span>
<span class="token comment">//</span>
<span class="token comment">// Query mode</span>
<span class="token comment">//</span>
<span class="token comment">// The gRPC query endpoint from 'eth_call' calls this method in query mode, and since the query handler don't call AnteHandler,</span>
<span class="token comment">// so we don't do real gas refund in that case.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>k <span class="token operator">*</span>Keeper<span class="token punctuation">)</span> <span class="token function">ApplyMessage</span><span class="token punctuation">(</span>evm <span class="token operator">*</span>vm<span class="token punctuation">.</span>EVM<span class="token punctuation">,</span> msg core<span class="token punctuation">.</span>Message<span class="token punctuation">,</span> cfg <span class="token operator">*</span>params<span class="token punctuation">.</span>ChainConfig<span class="token punctuation">,</span> query <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>types<span class="token punctuation">.</span>MsgEthereumTxResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> <span class="token punctuation">(</span>
		ret   <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span> <span class="token comment">// return bytes from evm execution</span>
		vmErr <span class="token builtin">error</span>  <span class="token comment">// vm errors do not effect consensus and are therefore not assigned to err</span>
	<span class="token punctuation">)</span>

	sender <span class="token operator">:=</span> vm<span class="token punctuation">.</span><span class="token function">AccountRef</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">From</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	contractCreation <span class="token operator">:=</span> msg<span class="token punctuation">.</span><span class="token function">To</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">nil</span>

	intrinsicGas<span class="token punctuation">,</span> err <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">GetEthIntrinsicGas</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> cfg<span class="token punctuation">,</span> contractCreation<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token comment">// should have already been checked on Ante Handler</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> stacktrace<span class="token punctuation">.</span><span class="token function">Propagate</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"intrinsic gas failed"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// Should check again even if it is checked on Ante Handler, because eth_call don't go through Ante Handler.</span>
	<span class="token keyword">if</span> msg<span class="token punctuation">.</span><span class="token function">Gas</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> intrinsicGas <span class="token punctuation">{</span>
		<span class="token comment">// eth_estimateGas will check for this exact error</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> stacktrace<span class="token punctuation">.</span><span class="token function">Propagate</span><span class="token punctuation">(</span>core<span class="token punctuation">.</span>ErrIntrinsicGas<span class="token punctuation">,</span> <span class="token string">"apply message"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	leftoverGas <span class="token operator">:=</span> msg<span class="token punctuation">.</span><span class="token function">Gas</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> intrinsicGas

	<span class="token keyword">if</span> contractCreation <span class="token punctuation">{</span>
		ret<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> leftoverGas<span class="token punctuation">,</span> vmErr <span class="token operator">=</span> evm<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>sender<span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">Data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> leftoverGas<span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		ret<span class="token punctuation">,</span> leftoverGas<span class="token punctuation">,</span> vmErr <span class="token operator">=</span> evm<span class="token punctuation">.</span><span class="token function">Call</span><span class="token punctuation">(</span>sender<span class="token punctuation">,</span> <span class="token operator">*</span>msg<span class="token punctuation">.</span><span class="token function">To</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">Data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> leftoverGas<span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> query <span class="token punctuation">{</span>
		<span class="token comment">// gRPC query handlers don't go through the AnteHandler to deduct the gas fee from the sender or have access historical state.</span>
		<span class="token comment">// We don't refund gas to the sender.</span>
		<span class="token comment">// For more info, see: https://github.com/tharsis/ethermint/issues/229 and https://github.com/cosmos/cosmos-sdk/issues/9636</span>
		leftoverGas <span class="token operator">+=</span> k<span class="token punctuation">.</span><span class="token function">GasToRefund</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">Gas</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> leftoverGas<span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token comment">// refund gas prior to handling the vm error in order to match the Ethereum gas consumption instead of the default SDK one.</span>
		leftoverGas<span class="token punctuation">,</span> err <span class="token operator">=</span> k<span class="token punctuation">.</span><span class="token function">RefundGas</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> leftoverGas<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> stacktrace<span class="token punctuation">.</span><span class="token function">Propagate</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"failed to refund gas leftover gas to sender %s"</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">From</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// EVM execution error needs to be available for the JSON-RPC client</span>
	<span class="token keyword">var</span> vmError <span class="token builtin">string</span>
	<span class="token keyword">if</span> vmErr <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		vmError <span class="token operator">=</span> vmErr<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	gasUsed <span class="token operator">:=</span> msg<span class="token punctuation">.</span><span class="token function">Gas</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> leftoverGas
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>types<span class="token punctuation">.</span>MsgEthereumTxResponse<span class="token punctuation">{</span>
		GasUsed<span class="token punctuation">:</span> gasUsed<span class="token punctuation">,</span>
		VmError<span class="token punctuation">:</span> vmError<span class="token punctuation">,</span>
		Ret<span class="token punctuation">:</span>     ret<span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">// GetEthIntrinsicGas returns the intrinsic gas cost for the transaction</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>k <span class="token operator">*</span>Keeper<span class="token punctuation">)</span> <span class="token function">GetEthIntrinsicGas</span><span class="token punctuation">(</span>msg core<span class="token punctuation">.</span>Message<span class="token punctuation">,</span> cfg <span class="token operator">*</span>params<span class="token punctuation">.</span>ChainConfig<span class="token punctuation">,</span> isContractCreation <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">uint64</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	height <span class="token operator">:=</span> big<span class="token punctuation">.</span><span class="token function">NewInt</span><span class="token punctuation">(</span>k<span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">BlockHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	homestead <span class="token operator">:=</span> cfg<span class="token punctuation">.</span><span class="token function">IsHomestead</span><span class="token punctuation">(</span>height<span class="token punctuation">)</span>
	istanbul <span class="token operator">:=</span> cfg<span class="token punctuation">.</span><span class="token function">IsIstanbul</span><span class="token punctuation">(</span>height<span class="token punctuation">)</span>

	<span class="token keyword">return</span> core<span class="token punctuation">.</span><span class="token function">IntrinsicGas</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">Data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">AccessList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> isContractCreation<span class="token punctuation">,</span> homestead<span class="token punctuation">,</span> istanbul<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// GasToRefund calculates the amount of gas the state machine should refund to the sender. It is</span>
<span class="token comment">// capped by half of the gas consumed.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>k <span class="token operator">*</span>Keeper<span class="token punctuation">)</span> <span class="token function">GasToRefund</span><span class="token punctuation">(</span>gasConsumed <span class="token builtin">uint64</span><span class="token punctuation">)</span> <span class="token builtin">uint64</span> <span class="token punctuation">{</span>
	<span class="token comment">// Apply refund counter, capped to half of the used gas.</span>
	refund <span class="token operator">:=</span> gasConsumed <span class="token operator">/</span> <span class="token number">2</span>
	availableRefund <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">GetRefund</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> refund <span class="token operator">></span> availableRefund <span class="token punctuation">{</span>
		<span class="token keyword">return</span> availableRefund
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> refund
<span class="token punctuation">}</span>

<span class="token comment">// RefundGas transfers the leftover gas to the sender of the message, caped to half of the total gas</span>
<span class="token comment">// consumed in the transaction. Additionally, the function sets the total gas consumed to the value</span>
<span class="token comment">// returned by the EVM execution, thus ignoring the previous intrinsic gas consumed during in the</span>
<span class="token comment">// AnteHandler.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>k <span class="token operator">*</span>Keeper<span class="token punctuation">)</span> <span class="token function">RefundGas</span><span class="token punctuation">(</span>msg core<span class="token punctuation">.</span>Message<span class="token punctuation">,</span> leftoverGas <span class="token builtin">uint64</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">uint64</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// safety check: leftover gas after execution should never exceed the gas limit defined on the message</span>
	<span class="token keyword">if</span> leftoverGas <span class="token operator">></span> msg<span class="token punctuation">.</span><span class="token function">Gas</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> leftoverGas<span class="token punctuation">,</span> stacktrace<span class="token punctuation">.</span><span class="token function">Propagate</span><span class="token punctuation">(</span>
			sdkerrors<span class="token punctuation">.</span><span class="token function">Wrapf</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span>ErrInconsistentGas<span class="token punctuation">,</span> <span class="token string">"leftover gas cannot be greater than gas limit (%d > %d)"</span><span class="token punctuation">,</span> leftoverGas<span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">Gas</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			<span class="token string">"failed to update gas consumed after refund of leftover gas"</span><span class="token punctuation">,</span>
		<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	gasConsumed <span class="token operator">:=</span> msg<span class="token punctuation">.</span><span class="token function">Gas</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> leftoverGas

	<span class="token comment">// calculate available gas to refund and add it to the leftover gas amount</span>
	refund <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">GasToRefund</span><span class="token punctuation">(</span>gasConsumed<span class="token punctuation">)</span>
	leftoverGas <span class="token operator">+=</span> refund

	<span class="token comment">// safety check: leftover gas after refund should never exceed the gas limit defined on the message</span>
	<span class="token keyword">if</span> leftoverGas <span class="token operator">></span> msg<span class="token punctuation">.</span><span class="token function">Gas</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> leftoverGas<span class="token punctuation">,</span> stacktrace<span class="token punctuation">.</span><span class="token function">Propagate</span><span class="token punctuation">(</span>
			sdkerrors<span class="token punctuation">.</span><span class="token function">Wrapf</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span>ErrInconsistentGas<span class="token punctuation">,</span> <span class="token string">"leftover gas cannot be greater than gas limit (%d > %d)"</span><span class="token punctuation">,</span> leftoverGas<span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">Gas</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			<span class="token string">"failed to update gas consumed after refund of %d gas"</span><span class="token punctuation">,</span> refund<span class="token punctuation">,</span>
		<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Return EVM tokens for remaining gas, exchanged at the original rate.</span>
	remaining <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>big<span class="token punctuation">.</span>Int<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Mul</span><span class="token punctuation">(</span><span class="token function">new</span><span class="token punctuation">(</span>big<span class="token punctuation">.</span>Int<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">SetUint64</span><span class="token punctuation">(</span>leftoverGas<span class="token punctuation">)</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">GasPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	<span class="token keyword">switch</span> remaining<span class="token punctuation">.</span><span class="token function">Sign</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">case</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>
		<span class="token comment">// negative refund errors</span>
		<span class="token keyword">return</span> leftoverGas<span class="token punctuation">,</span> sdkerrors<span class="token punctuation">.</span><span class="token function">Wrapf</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span>ErrInvalidRefund<span class="token punctuation">,</span> <span class="token string">"refunded amount value cannot be negative %d"</span><span class="token punctuation">,</span> remaining<span class="token punctuation">.</span><span class="token function">Int64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">case</span> <span class="token number">1</span><span class="token punctuation">:</span>
		<span class="token comment">// positive amount refund</span>
		params <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">GetParams</span><span class="token punctuation">(</span>k<span class="token punctuation">.</span>ctx<span class="token punctuation">)</span>
		refundedCoins <span class="token operator">:=</span> sdk<span class="token punctuation">.</span>Coins<span class="token punctuation">{</span>sdk<span class="token punctuation">.</span><span class="token function">NewCoin</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span>EvmDenom<span class="token punctuation">,</span> sdk<span class="token punctuation">.</span><span class="token function">NewIntFromBigInt</span><span class="token punctuation">(</span>remaining<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>

		<span class="token comment">// refund to sender from the fee collector module account, which is the escrow account in charge of collecting tx fees</span>

		err <span class="token operator">:=</span> k<span class="token punctuation">.</span>bankKeeper<span class="token punctuation">.</span><span class="token function">SendCoinsFromModuleToAccount</span><span class="token punctuation">(</span>k<span class="token punctuation">.</span>ctx<span class="token punctuation">,</span> authtypes<span class="token punctuation">.</span>FeeCollectorName<span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">From</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> refundedCoins<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			err <span class="token operator">=</span> sdkerrors<span class="token punctuation">.</span><span class="token function">Wrapf</span><span class="token punctuation">(</span>sdkerrors<span class="token punctuation">.</span>ErrInsufficientFunds<span class="token punctuation">,</span> <span class="token string">"fee collector account failed to refund fees: %s"</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> leftoverGas<span class="token punctuation">,</span> stacktrace<span class="token punctuation">.</span><span class="token function">Propagate</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"failed to refund %d leftover gas (%s)"</span><span class="token punctuation">,</span> leftoverGas<span class="token punctuation">,</span> refundedCoins<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token keyword">default</span><span class="token punctuation">:</span>
		<span class="token comment">// no refund, consume gas and update the tx gas meter</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> leftoverGas<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">// resetGasMeterAndConsumeGas reset first the gas meter consumed value to zero and set it back to the new value</span>
<span class="token comment">// 'gasUsed'</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>k <span class="token operator">*</span>Keeper<span class="token punctuation">)</span> <span class="token function">resetGasMeterAndConsumeGas</span><span class="token punctuation">(</span>gasUsed <span class="token builtin">uint64</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// reset the gas count</span>
	k<span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">GasMeter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">RefundGas</span><span class="token punctuation">(</span>k<span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">GasMeter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GasConsumed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"reset the gas count"</span><span class="token punctuation">)</span>
	k<span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">GasMeter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ConsumeGas</span><span class="token punctuation">(</span>gasUsed<span class="token punctuation">,</span> <span class="token string">"apply evm transaction"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// GetCoinbaseAddress returns the block proposer's validator operator address.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>k Keeper<span class="token punctuation">)</span> <span class="token function">GetCoinbaseAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>common<span class="token punctuation">.</span>Address<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	consAddr <span class="token operator">:=</span> sdk<span class="token punctuation">.</span><span class="token function">ConsAddress</span><span class="token punctuation">(</span>k<span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">BlockHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ProposerAddress<span class="token punctuation">)</span>
	validator<span class="token punctuation">,</span> found <span class="token operator">:=</span> k<span class="token punctuation">.</span>stakingKeeper<span class="token punctuation">.</span><span class="token function">GetValidatorByConsAddr</span><span class="token punctuation">(</span>k<span class="token punctuation">.</span>ctx<span class="token punctuation">,</span> consAddr<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>found <span class="token punctuation">{</span>
		<span class="token keyword">return</span> common<span class="token punctuation">.</span>Address<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> stacktrace<span class="token punctuation">.</span><span class="token function">Propagate</span><span class="token punctuation">(</span>
			sdkerrors<span class="token punctuation">.</span><span class="token function">Wrap</span><span class="token punctuation">(</span>stakingtypes<span class="token punctuation">.</span>ErrNoValidatorFound<span class="token punctuation">,</span> consAddr<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			<span class="token string">"failed to retrieve validator from block proposer address"</span><span class="token punctuation">,</span>
		<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	coinbase <span class="token operator">:=</span> common<span class="token punctuation">.</span><span class="token function">BytesToAddress</span><span class="token punctuation">(</span>validator<span class="token punctuation">.</span><span class="token function">GetOperator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> coinbase<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</span></span></span></span> <!----></span> <!----></span></span></p> <h3 id="antehandler"><a href="#antehandler" class="header-anchor">#</a> <code>AnteHandler</code></h3> <p>The Cosmos SDK <a href="https://docs.cosmos.network/master/basics/gas-fees.html#antehandler" target="_blank" rel="noopener noreferrer"><code>AnteHandler</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>
performs basic checks prior to transaction execution. These checks are usually signature
verification, transaction field validation, transaction fees, etc.</p> <p>Regarding gas consumption and fees, the <code>AnteHandler</code> checks that the user has enough balance to
cover for the tx cost (amount plus fees) as well as checking that the gas limit defined in the
message is greater or equal than the computed intrinsic gas for the message.</p> <h2 id="gas-refunds"><a href="#gas-refunds" class="header-anchor">#</a> Gas Refunds</h2> <p>In the EVM, gas can be specified prior to execution. The totality of the gas specified is consumed at the beginning of the execution (during the <code>AnteHandler</code> step) and the remaining gas is refunded back to
the user if any gas is left over after the execution. Additionally the EVM can also define gas to be refunded back to the user but those will be capped to a fraction of the used gas depending on the fork/version being used.</p> <h2 id="_0-fee-transactions"><a href="#_0-fee-transactions" class="header-anchor">#</a> 0 Fee Transactions</h2> <p>In Cosmos, a minimum gas price is not enforced by the <code>AnteHandler</code> as the <code>min-gas-prices</code> is
checked against the local node/validator. In other words, the minimum fees accepted are determined
by the validators of the network, and each validator can specify a different minimum value for their fees.
This potentially allows end users to submit 0 fee transactions if there is at least one single
validator that is willing to include transactions with <code>0</code> gas price in their blocks proposed.</p> <p>For this same reason, in Ethermint it is possible to send transactions with <code>0</code> fees for transaction
types other than the ones defined by the <code>evm</code> module. EVM module transactions cannot have <code>0</code> fees
as gas is required inherently by the EVM. This check is done by the EVM transactions stateless validation
(i.e <code>ValidateBasic</code>) function as well as on the custom <code>AnteHandler</code> defined by Ethermint.</p> <h2 id="gas-estimation"><a href="#gas-estimation" class="header-anchor">#</a> Gas estimation</h2> <p>Ethereum provides a JSON-RPC endpoint <code>eth_estimateGas</code> to help users set up a correct gas limit in their transactions.</p> <p>Unfortunately, we cannot make use of the SDK <code>tx simulation</code> for gas estimation because the pre-check in the Ante Handlers would require a valid signature, and the sender balance to be enough to pay for the gas. But in Ethereum, this endpoint can be called without specifying any sender address.</p> <p>For that reason, a specific query API <code>EstimateGas</code> is implemented in Ethermint. It will apply the transaction against the current block/state and perform a binary search in order to find the optimal gas value to return to the user (the same transaction will be applied over and over until we find the minimum gas needed before it fails). The reason we need to use a binary search is that the gas required for the
transaction might be higher than the value returned by the EVM after applying the transaction, so we need to try until we find the optimal value.</p> <p>A cache context will be used during the whole execution to avoid changes be persisted in the state.</p> <p>+++
https://github.com/tharsis/ethermint/blob/098da6d0cc0e0c4cefbddf632df1057383973e4a/x/evm/keeper/grpc_query.go#L392</p> <h2 hide="" id="next"><a href="#next" class="header-anchor">#</a> Next</h2> <p hide="">Learn about the different types of <a href="/main/basics/tokens.html">tokens</a> available</p></div><!----></div></div></div></div><div class="layout__main__content__aside__container" style="--height-banners:nullpx;" data-v-58560e81><div class="layout__main__content__aside aside__bottom__false" data-v-58560e81><!----></div><div class="layout__main__content__aside__banners" data-v-58560e81><a href="https://github.com/tharsis/ethermint/issues" target="_blank" data-v-58560e81><div data-v-31935645 data-v-58560e81><div class="container" data-v-31935645><svg width="100%" height="100%" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" class="icon" data-v-31935645><path d="M0.836491 13.7697C0.543598 14.0626 0.543598 14.5374 0.836492 14.8303C1.12939 15.1232 1.60426 15.1232 1.89715 14.8303L0.836491 13.7697ZM14.7729 1.95457C15.0658 1.66168 15.0658 1.1868 14.7729 0.893912C14.48 0.601019 14.0051 0.601019 13.7122 0.893913L14.7729 1.95457ZM14.6668 1H15.4168V0.25H14.6668V1ZM4.48498 0.25C4.07077 0.25 3.73498 0.585786 3.73498 1C3.73498 1.41421 4.07077 1.75 4.48498 1.75V0.25ZM13.9168 11.1818C13.9168 11.596 14.2526 11.9318 14.6668 11.9318C15.081 11.9318 15.4168 11.596 15.4168 11.1818H13.9168ZM1.89715 14.8303L14.7729 1.95457L13.7122 0.893913L0.836491 13.7697L1.89715 14.8303ZM14.6668 0.25H4.48498V1.75H14.6668V0.25ZM15.4168 11.1818V1H13.9168V11.1818H15.4168Z"></path></svg><div class="image" data-v-31935645><svg width="41" height="44" viewBox="0 0 41 44" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-31935645><path fill-rule="evenodd" clip-rule="evenodd" d="M4 1.8999H32C33.3807 1.8999 34.5 3.01919 34.5 4.3999V10.997L36 9.497V4.3999C36 2.19076 34.2091 0.399902 32 0.399902H4C1.79086 0.399902 0 2.19077 0 4.39991V39.5999C0 41.809 1.79086 43.5999 4 43.5999H32C34.2091 43.5999 36 41.809 36 39.5999V20.2096L34.5 21.7096V39.5999C34.5 40.9806 33.3807 42.0999 32 42.0999H4C2.61929 42.0999 1.5 40.9806 1.5 39.5999V4.39991C1.5 3.01919 2.61929 1.8999 4 1.8999ZM7.2 19.1999H26.2971L24.2971 21.1999H7.2V19.1999ZM7.2 15.7999H28.8V13.7999H7.2V15.7999ZM7.2 26.5999H16.2V24.5999H7.2V26.5999ZM20.8638 25.7372L20.7386 25.8624L20.6826 26.0303L18.9855 31.1215L18.4792 32.6406L19.9704 32.0571L24.8494 30.1479L24.9955 30.0908L25.1064 29.9798L37.9799 17.1063L39.7831 15.3032C40.9546 14.1316 40.9546 12.2321 39.7831 11.0606C38.6115 9.88898 36.712 9.88898 35.5404 11.0606L20.8638 25.7372ZM20.9149 30.0767L22.0496 26.6726L36.6011 12.1212C37.1869 11.5354 38.1366 11.5354 38.7224 12.1212C39.3082 12.707 39.3082 13.6567 38.7224 14.2425L37.4496 15.5153L36.2465 14.3122C35.9536 14.0193 35.4787 14.0193 35.1858 14.3122C34.8929 14.6051 34.8929 15.08 35.1858 15.3729L36.3889 16.576L24.5761 28.3888L23.6215 27.4342C23.3286 27.1413 22.8537 27.1413 22.5608 27.4342C22.2679 27.7271 22.2679 28.202 22.5608 28.4949L23.2349 29.1689L20.9149 30.0767Z" fill="var(--color-primary, blue)" data-v-31935645></path></svg></div><div class="h1" data-v-31935645>Found an Issue?</div><div class="h2" data-v-31935645>Help us improve this page by suggesting edits on GitHub.</div></div></div></a></div></div></div><div class="layout__main__gutter" data-v-58560e81><div data-v-15325c0d data-v-58560e81><div class="links" data-v-15325c0d><div class="links__wrapper" data-v-15325c0d><div class="links__container" data-v-15325c0d><a href="/main/basics/transactions.html" class="links__item links__item__left" data-v-15325c0d><div class="links__item__icon" data-v-15325c0d><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 64 64" data-v-15325c0d><title data-v-15325c0d>arrow-right</title><g stroke-linecap="square" stroke-linejoin="miter" stroke-width="2" data-v-15325c0d><line fill="none" stroke-miterlimit="10" x1="61" y1="32" x2="3" y2="32" stroke-linecap="butt" data-v-15325c0d></line><polyline fill="none" stroke-miterlimit="10" points="21,14 3,32 21,50 " data-v-15325c0d></polyline></g></svg></div><div data-v-15325c0d><div class="links__label" data-v-15325c0d>Previous</div><div class="links__item__title" data-v-15325c0d>Transactions</div><!----></div></a></div></div><div class="links__wrapper" data-v-15325c0d><div class="links__container" data-v-15325c0d><a href="/main/basics/tokens.html" class="links__item links__item__right" data-v-15325c0d><div data-v-15325c0d><div class="links__label" data-v-15325c0d>Next</div><div class="links__item__title" data-v-15325c0d>Tokens</div><div class="links__item__desc" data-v-15325c0d><div>Learn about the the different types of tokens available in Ethermint.</div></div></div><div class="links__item__icon" data-v-15325c0d><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 64 64" data-v-15325c0d><title data-v-15325c0d>arrow-right</title><g stroke-linecap="square" stroke-linejoin="miter" stroke-width="2" data-v-15325c0d><line fill="none" stroke-miterlimit="10" x1="3" y1="32" x2="61" y2="32" stroke-linecap="butt" data-v-15325c0d></line><polyline fill="none" stroke-miterlimit="10" points="43,14 61,32 43,50 " data-v-15325c0d></polyline></g></svg></div></a></div></div></div></div></div><div class="layout__main__footer" data-v-58560e81><div data-v-732a47ec data-v-58560e81><div class="wrapper" data-v-732a47ec><div class="container" data-v-732a47ec><div class="footer__wrapper" data-v-732a47ec><!----><!----><div class="logo" data-v-732a47ec><div class="logo__item" data-v-732a47ec><a href="https://tharsis.finance/ethermint" target="_blank" rel="noreferrer noopener" tag="div" class="logo__image" data-v-732a47ec><img src="/logo-bw.svg" data-v-732a47ec></a></div><div class="logo__item logo__link" data-v-732a47ec><a href="https://github.com/tharsis/ethermint" target="_blank" title="github" rel="noreferrer noopener" class="smallprint__item__links__item" data-v-732a47ec><svg width="24" height="24" xmlns="http://www.w3.org/2000/svg" fill-rule="evenodd" clip-rule="evenodd" fill="#aaa" data-v-732a47ec><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z" data-v-732a47ec></path></svg></a></div></div><div class="smallprint" data-v-732a47ec><div class="smallprint__item smallprint__item__links" data-v-732a47ec><a href="https://tharsis.finance/ethermint" data-v-732a47ec>tharsis.finance/ethermint</a></div><div class="smallprint__item__desc smallprint__item" data-v-732a47ec><div>This website is maintained by Tharsis.</div></div></div></div></div></div></div></div></div></div><div class="sheet__sidebar" data-v-ec82e5e0 data-v-58560e81><!----> <!----></div><div class="sheet__sidebar" data-v-ec82e5e0 data-v-58560e81><!----> <!----></div><div class="sheet__sidebar sheet__sidebar__toc" data-v-ec82e5e0 data-v-58560e81><!----> <!----></div></div><div class="global-ui"></div></div>
    <script src="/main/assets/js/app.f98083fb.js" defer></script><script src="/main/assets/js/24.fa347e59.js" defer></script><script src="/main/assets/js/21.d7c2ac56.js" defer></script><script src="/main/assets/js/19.0625d28d.js" defer></script><script src="/main/assets/js/25.9b8f94a0.js" defer></script><script src="/main/assets/js/52.8a695dc5.js" defer></script><script src="/main/assets/js/36.76bee6e4.js" defer></script><script src="/main/assets/js/10.f3e7ad84.js" defer></script><script src="/main/assets/js/7.b6a5918a.js" defer></script><script src="/main/assets/js/71.ac84ee59.js" defer></script><script src="/main/assets/js/2.885a972b.js" defer></script><script src="/main/assets/js/5.6324f117.js" defer></script><script src="/main/assets/js/34.f012bdf6.js" defer></script><script src="/main/assets/js/13.9564c10f.js" defer></script><script src="/main/assets/js/12.8ae7e994.js" defer></script><script src="/main/assets/js/20.e5b1c9ce.js" defer></script>
  </body>
</html>
